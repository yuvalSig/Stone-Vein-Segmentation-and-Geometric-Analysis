<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Crack Compliance Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
    .title { text-align:center; margin: 8px 0 16px; }
    .muted { color:#666; font-size: 14px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .btn { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; background:#16a34a; color:#fff; }
.btn:hover{ background:#15803d; }
    .btn2 { padding:10px 14px; border:1px solid #ddd; border-radius:10px; cursor:pointer; background:#fff; }
    input[type="number"]{ width:90px; padding:6px; }

    /* Drawing area */
    .canvasWrap {
      position: relative;
      width: fit-content;
      margin: 16px auto 0;
      border: 2px dashed #cfcfcf;
      border-radius: 12px;
      overflow: hidden;
    }
    #preview {
      display:block;
      max-width: 650px;
      height: auto;
    }
    #draw {
      position:absolute;
      left:0;
      top:0;
      z-index: 10;
      cursor: crosshair;
      pointer-events: auto;
    }

    .row { display:flex; gap:16px; flex-wrap:wrap; justify-content:center; }
    .col { flex: 1 1 480px; }
    .outimg { width:100%; border-radius:10px; border:1px solid #eee; }

  .imggrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:16px;
  align-items:start;
  justify-items:stretch;
}
@media (max-width: 1100px){
  .imggrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 640px){
  .imggrid{ grid-template-columns: 1fr; }
}
.imgcard{ min-width: 0; }
.imgcard h3{ margin:0 0 8px; text-align:center; }
.imgcard img{ width:100%; border-radius:10px; border:1px solid #eee; background:#fff; display:block; }
  .doc { text-align:center; margin: 10px 0 14px; }
  .doc code { background:#f2f2f2; padding:2px 6px; border-radius:6px; }

/* CM_TABLE_AUTOFIX */
.cmwrap{ display:flex; justify-content:center; }
.cm{ border-collapse:collapse; margin:12px auto; width:520px; max-width:100%; }
.cm th, .cm td{ border:1px solid #ddd; padding:10px; text-align:center; }
.cm th{ background:#f7f7f7; font-weight:700; }
.cm .rowhdr{ background:#fbfbfb; text-align:left; font-weight:700; }
.kv{ border-collapse:collapse; margin:12px auto; width:520px; max-width:100%; }
.kv th, .kv td{ border:1px solid #ddd; padding:8px; }
.kv th{ background:#f7f7f7; text-align:left; width:55%; }
.kv td{ text-align:right; }
</style>

</head>
<body>
  <div class="container">
    <h2 class="title">Marble Crack Compliance</h2>

    <div class="card">
      <form id="form" action="/analyze" method="post" enctype="multipart/form-data">
        <div class="controls">
          <label>Marble:
            <input id="marbleInput" type="file" name="marble" accept="image/*" required>
          </label>

          <label>Upload mask (optional):
            <input type="file" id="refmaskInput" name="refmask" accept="image/*">
          </label>

          <label>Low:
            <input type="number" step="0.01" name="hyst_low" value="{{ hyst_low or 0.2 }}">
          </label>

          <label>High:
            <input type="number" step="0.01" name="hyst_high" value="{{ hyst_high or 0.50 }}">
          </label>

          <button class="btn" type="submit">Analyze</button>
<label style="margin-left:16px;">
<input type="checkbox" name="use_closing">
Apply morphological closing (connect cracks)
</label>
          <label style="margin-left:16px; font-weight:500;">
            <input type="checkbox" name="use_refine">
            Morphology refinement
          </label>
          <button class="btn2" type="button" id="clearBtn">Clear drawing</button>

          <label class="muted">Brush:
            <input type="range" id="brush" min="2" max="40" value="12">
          </label>

          <input type="hidden" name="refmask_b64" id="refmask_b64">
        </div>

        <p class="muted" style="text-align:center;margin-top:10px;">
          Draw directly on the image (white strokes). The drawn mask is used as reference.
        </p>

        <div class="canvasWrap" id="wrap" style="display:none;">
          <img id="preview" alt="">
          <canvas id="draw"></canvas>
        </div>
      </form>
    </div>

    {% if pred_b64 %}
  <div style="height:16px"></div>

  <div class="card">
    <div class="doc">
      <div><b>Run settings</b></div>
      <div class="muted">
        Hysteresis thresholds: <code>low={{ hyst_low }}</code>, <code>high={{ hyst_high }}</code>
        &nbsp;|&nbsp; Hysteresis keeps weak pixels only if connected to strong pixels.
      </div>
      <div class="muted">
        Morphology refinement: <code>{{ "ON" if use_refine else "OFF" }}</code>
      </div>
    </div>

    <div class="imggrid">
      <div class="imgcard">
        <h3>Original</h3>
        <img src="data:image/png;base64,{{ marble_b64 }}" alt="Original">
      </div>

      <div class="imgcard">
        <h3>Pred mask</h3>
        <img src="data:image/png;base64,{{ pred_b64 }}" alt="Pred mask">
      </div>

      <div class="imgcard">
        <h3>Overlay</h3>
        <img src="data:image/png;base64,{{ overlay_b64 }}" alt="Overlay">
      </div>

      {% if thin_b64 %}
      <div class="imgcard">
        <h3>Thin mask</h3>
        <img src="data:image/png;base64,{{ thin_b64 }}" alt="Thin mask">
      </div>
      {% endif %}
    </div>
  </div>

  <p style="text-align:center; margin-top:12px;"><b>Components:</b> {{ n_components }}</p>

<div class="card" style="margin-top:16px;">

  {% if tp is defined and tp is not none %}
  <h3 style="margin-top:0;">Confusion Matrix</h3>

{# TN handling:
   - Prefer backend-provided tn if exists.
   - Else compute tn if total_pixels provided (common in pixel-level eval).
   - Else show "—".
#}
{% set tn_val = (tn if (tn is defined and tn is not none) else ((total_pixels - tp - fp - fn) if (total_pixels is defined and total_pixels is not none) else none)) %}

<div class="cmwrap">
  <table class="cm" aria-label="Confusion Matrix">
    <thead>
      <tr>
        <th></th>
        <th colspan="2">Predicted</th>
      </tr>
      <tr>
        <th></th>
        <th>Crack (Positive)</th>
        <th>Background (Negative)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th class="rowhdr">Actual Crack (Positive)</th>
        <td><b>TP</b><br>{{ tp }}</td>
        <td><b>FN</b><br>{{ fn }}</td>
      </tr>
      <tr>
        <th class="rowhdr">Actual Background (Negative)</th>
        <td><b>FP</b><br>{{ fp }}</td>
        <td><b>TN</b><br>{{ tn_val if tn_val is not none else "—" }}</td>
      </tr>
    </tbody>
  </table>
</div>

<h3 style="margin-top:16px;">Metrics</h3>
<table class="kv" aria-label="Metrics">
  <tbody>
    <tr>
      <th>Precision</th>
      <td>{{ "%.3f"|format(precision) if (precision is defined and precision is not none) else "—" }}</td>
    </tr>
    <tr>
      <th>Recall</th>
      <td>{{ "%.3f"|format(recall) if (recall is defined and recall is not none) else "—" }}</td>
    </tr>
    <tr>
      <th>F1-score</th>
      <td>{{ "%.3f"|format(f1) if (f1 is defined and f1 is not none) else "—" }}</td>
    </tr>
  </tbody>
</table>
{% endif %}

  {% if crack_rows %}
  <h3 style="margin-top:16px;">Crack table</h3>
  <div style="overflow-x:auto;">
    <table id="crackTable" style="border-collapse:collapse; width:100%;">
      <thead>
        <tr>
          <th style="border:1px solid #ddd; padding:6px;">Length (px)</th>
          <th style="border:1px solid #ddd; padding:6px;">Angle (deg)</th>
          <th style="border:1px solid #ddd; padding:6px;">Mean width (px)</th>
          <th style="border:1px solid #ddd; padding:6px;">Max width (px)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in crack_rows %}
        <tr>
          <td style="border:1px solid #ddd; padding:6px;">{{ r["length_px"] }}</td>
          <td style="border:1px solid #ddd; padding:6px;">{{ "%.1f"|format(r["orientation_deg"]) }}</td>
          <td style="border:1px solid #ddd; padding:6px;">{{ "%.2f"|format(r["mean_width_px"]) }}</td>
          <td style="border:1px solid #ddd; padding:6px;">{{ "%.2f"|format(r["max_width_px"]) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</div>

{% endif %}

<script>
  const marbleInput = document.getElementById("marbleInput");
  const preview = document.getElementById("preview");
  const canvas = document.getElementById("draw");
  const wrap = document.getElementById("wrap");
  const ctx = canvas.getContext("2d");
  const clearBtn = document.getElementById("clearBtn");
  const brush = document.getElementById("brush");
  const form = document.getElementById("form");
  const refmaskField = document.getElementById("refmask_b64");

    const refmaskInput = document.getElementById("refmaskInput");
  let drawing = false;
  let lastX = 0, lastY = 0;

  function setCanvasSizeToImage() {
    // Use displayed size (CSS pixels) so mouse mapping is 1:1
    const w = preview.clientWidth;
    const h = preview.clientHeight;

    canvas.width = Math.max(1, Math.round(w));
    canvas.height = Math.max(1, Math.round(h));

    canvas.style.width = w + "px";
    canvas.style.height = h + "px";

    // reset drawing settings
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  function start(e) {
    drawing = true;
      if (refmaskInput) refmaskInput.value = "";
    const p = getPos(e);
    lastX = p.x; lastY = p.y;
  }

  function move(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.strokeStyle = "white";
    ctx.lineWidth = parseInt(brush.value, 10);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    lastX = p.x; lastY = p.y;
  }

  function stop() { drawing = false; }

  clearBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", stop);

  // Touch support
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    const t = e.touches[0];
    start({clientX: t.clientX, clientY: t.clientY});
  }, {passive:false});

  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    const t = e.touches[0];
    move({clientX: t.clientX, clientY: t.clientY});
  }, {passive:false});

  canvas.addEventListener("touchend", (e) => {
    e.preventDefault();
    stop();
  }, {passive:false});

  marbleInput.addEventListener("change", () => {
    const f = marbleInput.files && marbleInput.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);

    preview.onload = () => {
      wrap.style.display = "block";
      // Wait a tick so clientWidth/Height are ready
      setTimeout(setCanvasSizeToImage, 0);
    };
    preview.src = url;
  });

  window.addEventListener("resize", () => {
    if (wrap.style.display !== "none") {
      const old = ctx.getImageData(0,0,canvas.width,canvas.height);
      setCanvasSizeToImage();
      // (optional) we don't restore old strokes on resize to keep it simple
    }
  });

  form.addEventListener("submit", () => {
  const hasUpload = !!(refmaskInput && refmaskInput.files && refmaskInput.files.length > 0);
  if (hasUpload) {
    // upload wins, do not send canvas
    refmaskField.value = "";
  } else {
    // default: always send canvas (empty canvas == empty mask)
    refmaskField.value = canvas.toDataURL("image/png");
  }
});
</script>
</body>
</html>
