<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Crack Compliance Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
    .title { text-align:center; margin: 8px 0 16px; }
    .muted { color:#666; font-size: 14px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .btn { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; background:#111; color:#fff; }
    .btn2 { padding:10px 14px; border:1px solid #ddd; border-radius:10px; cursor:pointer; background:#fff; }
    input[type="number"]{ width:90px; padding:6px; }

    /* Drawing area */
    .canvasWrap {
      position: relative;
      width: fit-content;
      margin: 16px auto 0;
      border: 2px dashed #cfcfcf;
      border-radius: 12px;
      overflow: hidden;
    }
    #preview {
      display:block;
      max-width: 650px;
      height: auto;
    }
    #draw {
      position:absolute;
      left:0;
      top:0;
      z-index: 10;
      cursor: crosshair;
      pointer-events: auto;
    }

    .row { display:flex; gap:16px; flex-wrap:wrap; justify-content:center; }
    .col { flex: 1 1 480px; }
    .outimg { width:100%; border-radius:10px; border:1px solid #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="title">Marble Crack Compliance</h2>

    <div class="card">
      <form id="form" action="/analyze" method="post" enctype="multipart/form-data">
        <div class="controls">
          <label>Marble:
            <input id="marbleInput" type="file" name="marble" accept="image/*" required>
          </label>

          <label>Upload mask (optional):
            <input type="file" name="refmask" accept="image/*">
          </label>

          <label>Low:
            <input type="number" step="0.01" name="hyst_low" value="{{ hyst_low or 0.2 }}">
          </label>

          <label>High:
            <input type="number" step="0.01" name="hyst_high" value="{{ hyst_high or 0.50 }}">
          </label>

          <button class="btn" type="submit">Analyze</button>
<label style="margin-left:16px;">
<input type="checkbox" name="use_closing">
Apply morphological closing (connect cracks)
</label>
          <label style="margin-left:16px; font-weight:500;">
            <input type="checkbox" name="use_refine">
            Morphology refinement
          </label>
          <button class="btn2" type="button" id="clearBtn">Clear drawing</button>

          <label class="muted">Brush:
            <input type="range" id="brush" min="2" max="40" value="12">
          </label>

          <input type="hidden" name="refmask_b64" id="refmask_b64">
        </div>

        <p class="muted" style="text-align:center;margin-top:10px;">
          Draw directly on the image (white strokes). The drawn mask is used as reference.
        </p>

        <div class="canvasWrap" id="wrap" style="display:none;">
          <img id="preview" alt="">
          <canvas id="draw"></canvas>
        </div>
      </form>
    </div>

    {% if pred_b64 %}
      <div style="height:16px"></div>
      <div class="card">
        <div class="row">
          <div class="col">
            <h3>Pred mask</h3>
{% if thin_b64 %}
  <h3>Thin mask (skeleton)</h3>
  <img class="outimg" src="data:image/png;base64,{{ thin_b64 }}"/>
{% endif %}

            <img class="outimg" src="data:image/png;base64,{{ pred_b64 }}"/>
          </div>
          <div class="col">
            <h3>Overlay</h3>
            <img class="outimg" src="data:image/png;base64,{{ overlay_b64 }}"/>
          </div>
        </div>

        <p><b>Components:</b> {{ n_components }}</p>

{% if crack_rows %}
  <h3>Crack table</h3>
  <table id="crackTable" style="border-collapse:collapse; width:100%;">
    <thead>
      <tr>
        <th style="border:1px solid #ddd; padding:6px;">Length (px)</th>
        <th style="border:1px solid #ddd; padding:6px;">Angle (deg)</th>
        <th style="border:1px solid #ddd; padding:6px;">Mean width (px)</th>
        <th style="border:1px solid #ddd; padding:6px;">Max width (px)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in crack_rows %}
      <tr>
        <td style="border:1px solid #ddd; padding:6px;">{{ r["length_px"] }}</td>
        <td style="border:1px solid #ddd; padding:6px;">{{ "%.1f"|format(r["orientation_deg"]) }}</td>
        <td style="border:1px solid #ddd; padding:6px;">{{ "%.2f"|format(r["mean_width_px"]) }}</td>
        <td style="border:1px solid #ddd; padding:6px;">{{ "%.2f"|format(r["max_width_px"]) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}


        {% if tp is not none %}
          <p><b>TP:</b> {{ tp }} | <b>FP:</b> {{ fp }} | <b>FN:</b> {{ fn }}</p>
          <p class="muted">Overlay legend: TP=Green, FP=Red, FN=Blue</p>
        {% else %}
          <p class="muted">Overlay legend: Pred=Red</p>
        {% endif %}
      </div>
    {% endif %}
  </div>

<script>
  const marbleInput = document.getElementById("marbleInput");
  const preview = document.getElementById("preview");
  const canvas = document.getElementById("draw");
  const wrap = document.getElementById("wrap");
  const ctx = canvas.getContext("2d");
  const clearBtn = document.getElementById("clearBtn");
  const brush = document.getElementById("brush");
  const form = document.getElementById("form");
  const refmaskField = document.getElementById("refmask_b64");

  let drawing = false;
  let lastX = 0, lastY = 0;

  function setCanvasSizeToImage() {
    // Use displayed size (CSS pixels) so mouse mapping is 1:1
    const w = preview.clientWidth;
    const h = preview.clientHeight;

    canvas.width = Math.max(1, Math.round(w));
    canvas.height = Math.max(1, Math.round(h));

    canvas.style.width = w + "px";
    canvas.style.height = h + "px";

    // reset drawing settings
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  function start(e) {
    drawing = true;
    const p = getPos(e);
    lastX = p.x; lastY = p.y;
  }

  function move(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.strokeStyle = "white";
    ctx.lineWidth = parseInt(brush.value, 10);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    lastX = p.x; lastY = p.y;
  }

  function stop() { drawing = false; }

  clearBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", stop);

  // Touch support
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    const t = e.touches[0];
    start({clientX: t.clientX, clientY: t.clientY});
  }, {passive:false});

  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    const t = e.touches[0];
    move({clientX: t.clientX, clientY: t.clientY});
  }, {passive:false});

  canvas.addEventListener("touchend", (e) => {
    e.preventDefault();
    stop();
  }, {passive:false});

  marbleInput.addEventListener("change", () => {
    const f = marbleInput.files && marbleInput.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);

    preview.onload = () => {
      wrap.style.display = "block";
      // Wait a tick so clientWidth/Height are ready
      setTimeout(setCanvasSizeToImage, 0);
    };
    preview.src = url;
  });

  window.addEventListener("resize", () => {
    if (wrap.style.display !== "none") {
      const old = ctx.getImageData(0,0,canvas.width,canvas.height);
      setCanvasSizeToImage();
      // (optional) we don't restore old strokes on resize to keep it simple
    }
  });

  form.addEventListener("submit", () => {
    refmaskField.value = canvas.toDataURL("image/png");
  });
</script>
</body>
</html>
